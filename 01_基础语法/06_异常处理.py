#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
============================================================================
æ¨¡å—åç§°ï¼šå¼‚å¸¸å¤„ç†
å­¦ä¹ ç›®æ ‡ï¼šæŒæ¡ Python å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå­¦ä¼šç¼–å†™å¥å£®çš„ä»£ç 
PyCharm æŠ€å·§ï¼šå­¦ä¹ æŸ¥çœ‹å¼‚å¸¸å †æ ˆå’Œè°ƒè¯•å¼‚å¸¸
============================================================================
"""

# ============================================================================
# ç¬¬ä¸€éƒ¨åˆ†ï¼šå¼‚å¸¸åŸºç¡€
# ============================================================================
"""
ã€æ¦‚å¿µè®²è§£ã€‘
å¼‚å¸¸æ˜¯ç¨‹åºè¿è¡Œæ—¶å‘ç”Ÿçš„é”™è¯¯ã€‚Python ä½¿ç”¨ try-except è¯­å¥æ¥æ•è·å’Œå¤„ç†å¼‚å¸¸ã€‚
è‰¯å¥½çš„å¼‚å¸¸å¤„ç†å¯ä»¥è®©ç¨‹åºæ›´åŠ å¥å£®ï¼Œä¸ä¼šå› ä¸ºæ„å¤–é”™è¯¯è€Œå´©æºƒã€‚
"""

# ----------------------------------------------------------------------------
# ä¸ºä»€ä¹ˆéœ€è¦å¼‚å¸¸å¤„ç†ï¼Ÿ
# ----------------------------------------------------------------------------

# ä¸å¤„ç†å¼‚å¸¸çš„åæœ
# print(10 / 0)  # ZeroDivisionError: division by zero
# ç¨‹åºå´©æºƒï¼Œåç»­ä»£ç æ— æ³•æ‰§è¡Œ

# ä½¿ç”¨å¼‚å¸¸å¤„ç†
try:
    result = 10 / 0
except ZeroDivisionError:
    print("é™¤æ•°ä¸èƒ½ä¸ºé›¶ï¼")

print("ç¨‹åºç»§ç»­æ‰§è¡Œ...")

# ã€PyCharm æŠ€å·§ã€‘
# å½“ç¨‹åºæŠ›å‡ºå¼‚å¸¸æ—¶ï¼ŒPyCharm ä¼šæ˜¾ç¤ºå¼‚å¸¸å †æ ˆ
# ç‚¹å‡»å †æ ˆä¸­çš„é“¾æ¥å¯ä»¥è·³è½¬åˆ°å¯¹åº”çš„ä»£ç è¡Œ

# ============================================================================
# ç¬¬äºŒéƒ¨åˆ†ï¼štry-except è¯­å¥
# ============================================================================

# ----------------------------------------------------------------------------
# åŸºæœ¬ try-except
# ----------------------------------------------------------------------------

try:
    num = int(input("è¯·è¾“å…¥æ•°å­—: "))
    print(f"ä½ è¾“å…¥çš„æ˜¯: {num}")
except ValueError:
    print("è¾“å…¥æ— æ•ˆï¼Œè¯·è¾“å…¥æ•°å­—ï¼")

# ----------------------------------------------------------------------------
# æ•è·å¤šç§å¼‚å¸¸
# ----------------------------------------------------------------------------

try:
    numbers = [1, 2, 3]
    index = int(input("è¯·è¾“å…¥ç´¢å¼•: "))
    print(f"å¯¹åº”å…ƒç´ : {numbers[index]}")
except ValueError:
    print("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•´æ•°ï¼")
except IndexError:
    print("ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼")

# ä½¿ç”¨å…ƒç»„æ•è·å¤šç§å¼‚å¸¸
try:
    # å¯èƒ½å‡ºé”™çš„ä»£ç 
    result = 10 / 0
    lst = [1, 2]
    print(lst[10])
except (ValueError, IndexError, ZeroDivisionError) as e:
    print(f"å‘ç”Ÿé”™è¯¯: {e}")

# ----------------------------------------------------------------------------
# æ•è·æ‰€æœ‰å¼‚å¸¸
# ----------------------------------------------------------------------------

try:
    # ä¸€äº›å¯èƒ½å‡ºé”™çš„ä»£ç 
    result = 10 / 0
except Exception as e:
    print(f"å‘ç”Ÿå¼‚å¸¸: {type(e).__name__}: {e}")

# ã€æ³¨æ„ã€‘æ•è·æ‰€æœ‰å¼‚å¸¸è¦è°¨æ…ä½¿ç”¨ï¼Œå¯èƒ½ä¼šéšè—çœŸæ­£çš„bug

# ============================================================================
# ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®Œæ•´çš„å¼‚å¸¸å¤„ç†ç»“æ„
# ============================================================================

# ----------------------------------------------------------------------------
# try-except-else-finally
# ----------------------------------------------------------------------------

def divide(a, b):
    """é™¤æ³•å‡½æ•°ï¼Œå¸¦æœ‰å®Œæ•´çš„å¼‚å¸¸å¤„ç†"""
    try:
        result = a / b
    except ZeroDivisionError:
        print("é”™è¯¯ï¼šé™¤æ•°ä¸èƒ½ä¸ºé›¶ï¼")
        return None
    except TypeError:
        print("é”™è¯¯ï¼šå‚æ•°ç±»å‹ä¸æ­£ç¡®ï¼")
        return None
    else:
        # æ²¡æœ‰å¼‚å¸¸æ—¶æ‰§è¡Œ
        print("è®¡ç®—æˆåŠŸï¼")
        return result
    finally:
        # æ— è®ºæ˜¯å¦å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œ
        print("è®¡ç®—ç»“æŸã€‚")

print(divide(10, 2))
print("-" * 20)
print(divide(10, 0))

# finally çš„å¸¸è§ç”¨é€”ï¼šèµ„æºæ¸…ç†
def read_file(filename):
    """è¯»å–æ–‡ä»¶ï¼Œç¡®ä¿æ–‡ä»¶è¢«å…³é—­"""
    f = None
    try:
        f = open(filename, 'r', encoding='utf-8')
        content = f.read()
        return content
    except FileNotFoundError:
        print(f"æ–‡ä»¶ {filename} ä¸å­˜åœ¨")
        return None
    finally:
        if f:
            f.close()
            print("æ–‡ä»¶å·²å…³é—­")

# æ›´æ¨èä½¿ç”¨ with è¯­å¥
def read_file_better(filename):
    """ä½¿ç”¨ with è¯­å¥è¯»å–æ–‡ä»¶"""
    try:
        with open(filename, 'r', encoding='utf-8') as f:
            return f.read()
    except FileNotFoundError:
        print(f"æ–‡ä»¶ {filename} ä¸å­˜åœ¨")
        return None

# ============================================================================
# ç¬¬å››éƒ¨åˆ†ï¼šå¼‚å¸¸å¯¹è±¡
# ============================================================================

# ----------------------------------------------------------------------------
# è·å–å¼‚å¸¸ä¿¡æ¯
# ----------------------------------------------------------------------------

try:
    result = 10 / 0
except ZeroDivisionError as e:
    print(f"å¼‚å¸¸ç±»å‹: {type(e).__name__}")
    print(f"å¼‚å¸¸ä¿¡æ¯: {e}")
    print(f"å¼‚å¸¸å‚æ•°: {e.args}")

# ä½¿ç”¨ traceback è·å–å®Œæ•´å †æ ˆ
import traceback

try:
    def func_a():
        func_b()
    
    def func_b():
        func_c()
    
    def func_c():
        raise ValueError("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¼‚å¸¸")
    
    func_a()
except Exception as e:
    print("\nå®Œæ•´å †æ ˆä¿¡æ¯:")
    traceback.print_exc()

# ============================================================================
# ç¬¬äº”éƒ¨åˆ†ï¼šä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸
# ============================================================================

# ----------------------------------------------------------------------------
# raise è¯­å¥
# ----------------------------------------------------------------------------

def set_age(age):
    """è®¾ç½®å¹´é¾„ï¼Œå¦‚æœå¹´é¾„æ— æ•ˆåˆ™æŠ›å‡ºå¼‚å¸¸"""
    if not isinstance(age, int):
        raise TypeError("å¹´é¾„å¿…é¡»æ˜¯æ•´æ•°")
    if age < 0 or age > 150:
        raise ValueError("å¹´é¾„å¿…é¡»åœ¨ 0-150 ä¹‹é—´")
    return age

# æµ‹è¯•
try:
    set_age(-5)
except (TypeError, ValueError) as e:
    print(f"è®¾ç½®å¹´é¾„å¤±è´¥: {e}")

# ----------------------------------------------------------------------------
# é‡æ–°æŠ›å‡ºå¼‚å¸¸
# ----------------------------------------------------------------------------

def process_data(data):
    """å¤„ç†æ•°æ®"""
    try:
        # å¯èƒ½å‡ºé”™çš„ä»£ç 
        result = int(data)
    except ValueError as e:
        print(f"æ•°æ®å¤„ç†å¤±è´¥: {e}")
        raise  # é‡æ–°æŠ›å‡ºå¼‚å¸¸

# ============================================================================
# ç¬¬å…­éƒ¨åˆ†ï¼šè‡ªå®šä¹‰å¼‚å¸¸
# ============================================================================

# ----------------------------------------------------------------------------
# åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸ç±»
# ----------------------------------------------------------------------------

class InsufficientFundsError(Exception):
    """ä½™é¢ä¸è¶³å¼‚å¸¸"""
    def __init__(self, balance, amount):
        self.balance = balance
        self.amount = amount
        self.message = f"ä½™é¢ä¸è¶³: å½“å‰ä½™é¢ {balance}ï¼Œéœ€è¦ {amount}"
        super().__init__(self.message)

class BankAccount:
    """é“¶è¡Œè´¦æˆ·ç±»"""
    def __init__(self, balance=0):
        self.balance = balance
    
    def withdraw(self, amount):
        """å–æ¬¾"""
        if amount > self.balance:
            raise InsufficientFundsError(self.balance, amount)
        self.balance -= amount
        return self.balance
    
    def deposit(self, amount):
        """å­˜æ¬¾"""
        self.balance += amount
        return self.balance

# ä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸
account = BankAccount(100)

try:
    account.withdraw(150)
except InsufficientFundsError as e:
    print(f"å–æ¬¾å¤±è´¥: {e}")
    print(f"å½“å‰ä½™é¢: {e.balance}")

# ----------------------------------------------------------------------------
# å¼‚å¸¸é“¾
# ----------------------------------------------------------------------------

class DataProcessingError(Exception):
    """æ•°æ®å¤„ç†å¼‚å¸¸"""
    pass

def process_file(filename):
    """å¤„ç†æ–‡ä»¶"""
    try:
        with open(filename, 'r') as f:
            data = f.read()
            # å¤„ç†æ•°æ®...
    except FileNotFoundError as e:
        # å°†åŸå§‹å¼‚å¸¸é“¾æ¥åˆ°æ–°å¼‚å¸¸
        raise DataProcessingError(f"æ— æ³•å¤„ç†æ–‡ä»¶ {filename}") from e

# ============================================================================
# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå¸¸è§å†…ç½®å¼‚å¸¸
# ============================================================================

"""
å¸¸è§å†…ç½®å¼‚å¸¸ï¼š

åŸºç¡€å¼‚å¸¸ï¼š
- BaseException: æ‰€æœ‰å¼‚å¸¸çš„åŸºç±»
- Exception: å¸¸è§„å¼‚å¸¸çš„åŸºç±»

ç¨‹åºé”™è¯¯ï¼š
- ValueError: å€¼é”™è¯¯
- TypeError: ç±»å‹é”™è¯¯
- NameError: åç§°æœªå®šä¹‰
- IndexError: ç´¢å¼•è¶Šç•Œ
- KeyError: é”®ä¸å­˜åœ¨
- AttributeError: å±æ€§ä¸å­˜åœ¨

è®¡ç®—é”™è¯¯ï¼š
- ZeroDivisionError: é™¤é›¶é”™è¯¯
- OverflowError: æ•°å€¼æº¢å‡º

IOé”™è¯¯ï¼š
- FileNotFoundError: æ–‡ä»¶ä¸å­˜åœ¨
- PermissionError: æƒé™ä¸è¶³
- IOError: è¾“å…¥è¾“å‡ºé”™è¯¯

å…¶ä»–ï¼š
- KeyboardInterrupt: ç”¨æˆ·ä¸­æ–­ï¼ˆCtrl+Cï¼‰
- StopIteration: è¿­ä»£ç»“æŸ
- AssertionError: æ–­è¨€å¤±è´¥
"""

# ç¤ºä¾‹ï¼šå„ç§å¼‚å¸¸
def demonstrate_exceptions():
    """æ¼”ç¤ºå„ç§å¼‚å¸¸"""
    exceptions = {
        "ValueError": lambda: int("abc"),
        "TypeError": lambda: "hello" + 123,
        "IndexError": lambda: [1, 2, 3][10],
        "KeyError": lambda: {"a": 1}["b"],
        "AttributeError": lambda: "".nonexistent,
        "ZeroDivisionError": lambda: 1 / 0,
    }
    
    for name, func in exceptions.items():
        try:
            func()
        except Exception as e:
            print(f"{name}: {e}")

demonstrate_exceptions()

# ============================================================================
# ç¬¬å…«éƒ¨åˆ†ï¼šå¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ
# ============================================================================

# ----------------------------------------------------------------------------
# 1. å…·ä½“å¼‚å¸¸ä¼˜äºé€šç”¨å¼‚å¸¸
# ----------------------------------------------------------------------------

# ä¸æ¨è
# try:
#     do_something()
# except:
#     pass

# æ¨è
try:
    int("123")
except ValueError as e:
    print(f"è½¬æ¢å¤±è´¥: {e}")

# ----------------------------------------------------------------------------
# 2. ä¸è¦ç”¨å¼‚å¸¸æ§åˆ¶æµç¨‹
# ----------------------------------------------------------------------------

# ä¸æ¨è
# try:
#     while True:
#         item = next(iterator)
#         process(item)
# except StopIteration:
#     pass

# æ¨è
# for item in iterator:
#     process(item)

# ----------------------------------------------------------------------------
# 3. é€‚å½“çš„å¼‚å¸¸æ¶ˆæ¯
# ----------------------------------------------------------------------------

def divide_numbers(a, b):
    """é™¤æ³•å‡½æ•°"""
    if b == 0:
        raise ValueError(f"é™¤æ•°ä¸èƒ½ä¸ºé›¶: {a} / {b}")
    return a / b

# ----------------------------------------------------------------------------
# 4. ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
# ----------------------------------------------------------------------------

# è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨
class Timer:
    """è®¡æ—¶å™¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    import time
    
    def __enter__(self):
        self.start = time.time()
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        elapsed = time.time() - self.start
        if exc_type:
            print(f"æ‰§è¡Œå¤±è´¥ï¼Œè€—æ—¶: {elapsed:.2f}ç§’")
            print(f"å¼‚å¸¸: {exc_val}")
        else:
            print(f"æ‰§è¡ŒæˆåŠŸï¼Œè€—æ—¶: {elapsed:.2f}ç§’")
        return False  # ä¸æŠ‘åˆ¶å¼‚å¸¸

# ä½¿ç”¨
with Timer():
    # ä¸€äº›æ“ä½œ
    total = sum(range(1000000))
    print(f"è®¡ç®—å®Œæˆ: {total}")

# ----------------------------------------------------------------------------
# 5. æ—¥å¿—è®°å½•
# ----------------------------------------------------------------------------

import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

def risky_operation():
    """å¯èƒ½å‡ºé”™çš„æ“ä½œ"""
    try:
        result = 10 / 0
    except Exception as e:
        logging.error(f"æ“ä½œå¤±è´¥: {e}", exc_info=True)
        raise

# ============================================================================
# ç¬¬ä¹éƒ¨åˆ†ï¼šå®é™…åº”ç”¨ç¤ºä¾‹
# ============================================================================

# ----------------------------------------------------------------------------
# ç”¨æˆ·è¾“å…¥éªŒè¯
# ----------------------------------------------------------------------------

def get_valid_input(prompt, input_type=int, min_val=None, max_val=None):
    """è·å–æœ‰æ•ˆè¾“å…¥"""
    while True:
        try:
            value = input_type(input(prompt))
            
            if min_val is not None and value < min_val:
                print(f"å€¼ä¸èƒ½å°äº {min_val}")
                continue
            
            if max_val is not None and value > max_val:
                print(f"å€¼ä¸èƒ½å¤§äº {max_val}")
                continue
            
            return value
        except ValueError:
            print(f"è¯·è¾“å…¥æœ‰æ•ˆçš„ {input_type.__name__} ç±»å‹")

# age = get_valid_input("è¯·è¾“å…¥å¹´é¾„: ", int, 0, 150)
# print(f"ä½ çš„å¹´é¾„æ˜¯: {age}")

# ----------------------------------------------------------------------------
# é…ç½®æ–‡ä»¶å¤„ç†
# ----------------------------------------------------------------------------

import json

def load_config(filename):
    """åŠ è½½é…ç½®æ–‡ä»¶"""
    try:
        with open(filename, 'r', encoding='utf-8') as f:
            config = json.load(f)
        return config
    except FileNotFoundError:
        print(f"é…ç½®æ–‡ä»¶ {filename} ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®")
        return {"default": True}
    except json.JSONDecodeError as e:
        print(f"é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯: {e}")
        return {"default": True}

# ----------------------------------------------------------------------------
# é‡è¯•æœºåˆ¶
# ----------------------------------------------------------------------------

import time
import random

def retry_on_failure(func, max_retries=3, delay=1):
    """å¤±è´¥é‡è¯•è£…é¥°å™¨"""
    for attempt in range(max_retries):
        try:
            return func()
        except Exception as e:
            if attempt == max_retries - 1:
                raise
            print(f"ç¬¬ {attempt + 1} æ¬¡å°è¯•å¤±è´¥: {e}")
            time.sleep(delay)

# æµ‹è¯•
def unstable_function():
    """æ¨¡æ‹Ÿä¸ç¨³å®šå‡½æ•°"""
    if random.random() < 0.7:
        raise ConnectionError("è¿æ¥å¤±è´¥")
    return "æˆåŠŸ"

try:
    result = retry_on_failure(unstable_function)
    print(f"æœ€ç»ˆç»“æœ: {result}")
except Exception as e:
    print(f"æ‰€æœ‰å°è¯•éƒ½å¤±è´¥: {e}")

# ============================================================================
# ç»ƒä¹ é¢˜
# ============================================================================
"""
ã€ç»ƒä¹ 1ã€‘ç¼–å†™ä¸€ä¸ªå®‰å…¨çš„è®¡ç®—å™¨å‡½æ•°
è¦æ±‚ï¼š
- å¤„ç†é™¤é›¶é”™è¯¯
- å¤„ç†ç±»å‹é”™è¯¯
- å¤„ç†æ— æ•ˆè¾“å…¥

ã€ç»ƒä¹ 2ã€‘åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸ç±»
è¦æ±‚ï¼š
- åˆ›å»º InvalidAgeError å¼‚å¸¸
- åˆ›å»º Person ç±»ï¼Œåœ¨è®¾ç½®å¹´é¾„æ—¶éªŒè¯

ã€ç»ƒä¹ 3ã€‘å®ç°é‡è¯•è£…é¥°å™¨
è¦æ±‚ï¼š
- å¯ä»¥æŒ‡å®šé‡è¯•æ¬¡æ•°
- å¯ä»¥æŒ‡å®šé‡è¯•é—´éš”
- å¯ä»¥æŒ‡å®šè¦æ•è·çš„å¼‚å¸¸ç±»å‹
"""

# ============================================================================
# æœ¬èŠ‚å°ç»“
# ============================================================================
"""
âœ… æŒæ¡çš„çŸ¥è¯†ç‚¹ï¼š
1. try-except åŸºæœ¬è¯­æ³•
2. æ•è·å¤šç§å¼‚å¸¸
3. try-except-else-finally å®Œæ•´ç»“æ„
4. ä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸ (raise)
5. è‡ªå®šä¹‰å¼‚å¸¸ç±»
6. å¼‚å¸¸é“¾å’Œå¼‚å¸¸ä¿¡æ¯è·å–
7. å¸¸è§å†…ç½®å¼‚å¸¸
8. å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ

ğŸ”§ PyCharm æŠ€å·§ï¼š
1. æŸ¥çœ‹å¼‚å¸¸å †æ ˆ
2. å¼‚å¸¸æ–­ç‚¹ (Exception Breakpoint)
3. åœ¨ Debug ä¸­æŸ¥çœ‹å¼‚å¸¸å˜é‡
4. ä½¿ç”¨ Evaluate Expression æµ‹è¯•å¼‚å¸¸å¤„ç†

â¡ï¸ æ­å–œå®ŒæˆåŸºç¡€è¯­æ³•æ¨¡å—ï¼
â¡ï¸ ä¸‹ä¸€æ¨¡å—ï¼šæ•°æ®ç»“æ„
"""

if __name__ == "__main__":
    print("\n" + "=" * 60)
    print("å¼‚å¸¸å¤„ç†æ¨¡å—å­¦ä¹ å®Œæˆï¼")
    print("åŸºç¡€è¯­æ³•æ¨¡å—å…¨éƒ¨å®Œæˆï¼")
    print("=" * 60)
