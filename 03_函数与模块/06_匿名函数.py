#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
============================================================================
模块名称：匿名函数
学习目标：掌握 lambda 表达式和函数式编程工具
PyCharm 技巧：学习使用代码补全快速编写 lambda
============================================================================
"""

# ============================================================================
# 第一部分：Lambda 基础
# ============================================================================
"""
【概念讲解】
Lambda 是一种创建匿名函数的方式。
语法：lambda 参数: 表达式

特点：
1. 只能是单个表达式
2. 自动返回表达式的值
3. 适用于简单、一次性使用的函数
"""

# ----------------------------------------------------------------------------
# 基本语法
# ----------------------------------------------------------------------------

# 传统函数定义
def add(x, y):
    return x + y

# Lambda 表达式
add_lambda = lambda x, y: x + y

print(f"传统函数: {add(3, 5)}")
print(f"Lambda: {add_lambda(3, 5)}")

# 立即调用
result = (lambda x, y: x * y)(3, 5)
print(f"立即调用: {result}")

# ----------------------------------------------------------------------------
# Lambda 的使用场景
# ----------------------------------------------------------------------------

# 1. 作为排序键
students = [
    {"name": "张三", "age": 20},
    {"name": "李四", "age": 18},
    {"name": "王五", "age": 22},
]

# 按年龄排序
students.sort(key=lambda s: s["age"])
print(f"按年龄排序: {[s['name'] for s in students]}")

# 2. 作为过滤条件
numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
evens = list(filter(lambda x: x % 2 == 0, numbers))
print(f"偶数: {evens}")

# 3. 作为映射函数
squares = list(map(lambda x: x ** 2, numbers))
print(f"平方: {squares}")

# ============================================================================
# 第二部分：函数式编程工具
# ============================================================================

# ----------------------------------------------------------------------------
# map() 函数
# ----------------------------------------------------------------------------

# 对每个元素应用函数
numbers = [1, 2, 3, 4, 5]

# 使用 map
doubled = list(map(lambda x: x * 2, numbers))
print(f"翻倍: {doubled}")

# 多个序列
list1 = [1, 2, 3]
list2 = [10, 20, 30]
sums = list(map(lambda a, b: a + b, list1, list2))
print(f"对应相加: {sums}")

# 使用列表推导式（更 Pythonic）
doubled = [x * 2 for x in numbers]

# ----------------------------------------------------------------------------
# filter() 函数
# ----------------------------------------------------------------------------

# 过滤元素
numbers = range(1, 20)

# 过滤质数
def is_prime(n):
    if n < 2:
        return False
    for i in range(2, int(n ** 0.5) + 1):
        if n % i == 0:
            return False
    return True

primes = list(filter(is_prime, numbers))
print(f"质数: {primes}")

# 使用列表推导式
primes = [n for n in numbers if is_prime(n)]

# ----------------------------------------------------------------------------
# reduce() 函数
# ----------------------------------------------------------------------------

from functools import reduce

# 累积计算
numbers = [1, 2, 3, 4, 5]

# 求和
total = reduce(lambda a, b: a + b, numbers)
print(f"总和: {total}")

# 求乘积
product = reduce(lambda a, b: a * b, numbers)
print(f"乘积: {product}")

# 带初始值
total = reduce(lambda a, b: a + b, numbers, 100)
print(f"带初始值的总和: {total}")

# 找最大值
maximum = reduce(lambda a, b: a if a > b else b, numbers)
print(f"最大值: {maximum}")

# ----------------------------------------------------------------------------
# sorted() 函数
# ----------------------------------------------------------------------------

# 自定义排序
words = ["banana", "Apple", "cherry", "Date"]

# 忽略大小写排序
sorted_words = sorted(words, key=lambda x: x.lower())
print(f"排序: {sorted_words}")

# 按长度排序
sorted_by_length = sorted(words, key=len)
print(f"按长度: {sorted_by_length}")

# 降序
sorted_desc = sorted(words, reverse=True)
print(f"降序: {sorted_desc}")

# ============================================================================
# 第三部分：Lambda 高级用法
# ============================================================================

# ----------------------------------------------------------------------------
# 条件表达式
# ----------------------------------------------------------------------------

# Lambda 中的条件
classify = lambda x: "正数" if x > 0 else ("负数" if x < 0 else "零")
print(f"分类: {classify(5)}, {classify(-3)}, {classify(0)}")

# ----------------------------------------------------------------------------
# 闭包
# ----------------------------------------------------------------------------

# Lambda 实现闭包
make_adder = lambda x: lambda y: x + y
add_5 = make_adder(5)
print(f"闭包加法: {add_5(3)}")

# ----------------------------------------------------------------------------
# 字典中的 Lambda
# ----------------------------------------------------------------------------

# 策略模式
operations = {
    'add': lambda a, b: a + b,
    'sub': lambda a, b: a - b,
    'mul': lambda a, b: a * b,
    'div': lambda a, b: a / b if b != 0 else None,
}

op = 'add'
result = operations[op](10, 5)
print(f"计算结果: {result}")

# ============================================================================
# 第四部分：Lambda vs 普通函数
# ============================================================================

# 推荐：普通函数
def calculate_discount(price, rate):
    """计算折扣价格"""
    return price * (1 - rate)

# 不推荐：复杂 Lambda
# calculate_discount = lambda price, rate: price * (1 - rate)

"""
【选择建议】

使用 Lambda：
- 简单、一次性的函数
- 作为高阶函数的参数
- 函数体只有单个表达式

使用普通函数：
- 需要文档字符串
- 逻辑较复杂
- 需要多行代码
- 需要复用
"""

# ============================================================================
# 第五部分：实战示例
# ============================================================================

# 数据处理管道
data = [
    {"name": "张三", "score": 85},
    {"name": "李四", "score": 92},
    {"name": "王五", "score": 78},
    {"name": "赵六", "score": 95},
]

# 找出高分学生并按分数排序
result = sorted(
    filter(lambda x: x["score"] >= 85, data),
    key=lambda x: x["score"],
    reverse=True
)

print("\n高分学生:")
for student in result:
    print(f"  {student['name']}: {student['score']}")

# 使用列表推导式（更清晰）
result = sorted(
    [s for s in data if s["score"] >= 85],
    key=lambda x: x["score"],
    reverse=True
)

# ============================================================================
# 本节小结
# ============================================================================
"""
✅ 掌握的知识点：
1. Lambda 语法和基本使用
2. map()、filter()、reduce()
3. sorted() 与 key 参数
4. Lambda 的适用场景
5. Lambda vs 普通函数的选择

➡️ 下一节：装饰器
"""

if __name__ == "__main__":
    print("\n" + "=" * 60)
    print("匿名函数模块学习完成！")
    print("=" * 60)
