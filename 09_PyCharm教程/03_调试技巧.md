#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
============================================================================
模块名称：调试技巧
学习目标：掌握 PyCharm 调试功能，高效定位问题
PyCharm 技巧：深入学习调试器功能
============================================================================
"""

# ============================================================================
# 第一部分：断点类型
# ============================================================================
"""
【概念讲解】
PyCharm 支持多种断点类型：
1. 行断点 - 在特定行暂停
2. 条件断点 - 满足条件时暂停
3. 日志断点 - 不暂停，只记录日志
4. 异常断点 - 抛出异常时暂停
"""

# ----------------------------------------------------------------------------
# 示例代码用于调试演示
# ----------------------------------------------------------------------------

def process_data(data_list):
    """处理数据列表"""
    results = []
    
    for i, item in enumerate(data_list):
        # 【行断点】在这里设置断点
        if item > 0:
            processed = item * 2
        elif item < 0:
            processed = abs(item) * 3
        else:
            processed = 0
        
        # 【条件断点】在 i > 5 时暂停
        results.append(processed)
    
    return results

# 测试数据
test_data = [1, -2, 0, 5, -3, 8, 0, -1, 4, 2, -5, 3]
result = process_data(test_data)
print(f"处理结果: {result}")

# ============================================================================
# 第二部分：调试控制
# ============================================================================
"""
【调试控制操作】

F8 (Step Over)
- 执行当前行
- 如果是函数调用，不进入函数内部
- 最常用的操作

F7 (Step Into)
- 进入函数内部
- 用于查看函数内部执行过程

Shift+F8 (Step Out)
- 执行完当前函数剩余代码
- 返回到调用处

F9 (Resume)
- 继续执行到下一个断点

Alt+F9 (Run to Cursor)
- 执行到光标位置

Alt+F8 (Evaluate Expression)
- 执行任意表达式
- 可以修改变量值
"""

def outer_function(x):
    """外层函数"""
    y = x + 10
    result = inner_function(y)
    return result * 2

def inner_function(z):
    """内层函数"""
    # 在这里设置断点，使用 Step Out 返回 outer_function
    return z ** 2

value = outer_function(5)
print(f"结果: {value}")

# ============================================================================
# 第三部分：变量监视
# ============================================================================
"""
【变量监视技巧】

Variables 面板：
- 显示当前作用域的所有变量
- 可以展开查看复杂数据结构

Watches 面板：
- 添加要监视的表达式
- 可以监视任意 Python 表达式

添加监视：
- 右键变量 → Add to Watches
- 在 Watches 面板点击 +
"""

def calculate_statistics(numbers):
    """计算统计信息"""
    total = sum(numbers)
    count = len(numbers)
    average = total / count if count > 0 else 0
    
    # 【调试提示】在 Variables 面板观察：
    # - numbers: 列表内容
    # - total: 总和
    # - count: 数量
    # - average: 平均值
    
    # 【添加监视表达式】：
    # - max(numbers)
    # - min(numbers)
    # - sorted(numbers)
    
    return {
        "total": total,
        "count": count,
        "average": average
    }

stats = calculate_statistics([85, 90, 78, 92, 88])
print(f"统计: {stats}")

# ============================================================================
# 第四部分：条件断点和日志断点
# ============================================================================

def find_issues(records):
    """查找问题记录"""
    issues = []
    
    for record in records:
        # 【条件断点示例】
        # 右键断点 → 设置条件: record["value"] < 0
        # 只有值为负时才暂停
        
        # 【日志断点示例】
        # 右键断点 → 取消 "Suspend" → 勾选 "Log evaluated expression"
        # 输入: f"处理: {record['id']} = {record['value']}"
        
        if record["value"] < 0:
            issues.append(record["id"])
    
    return issues

test_records = [
    {"id": 1, "value": 10},
    {"id": 2, "value": -5},  # 条件断点会在这里暂停
    {"id": 3, "value": 20},
    {"id": 4, "value": -3},  # 条件断点会在这里暂停
]

issues = find_issues(test_records)
print(f"问题记录: {issues}")

# ============================================================================
# 第五部分：异常断点
# ============================================================================
"""
【异常断点设置】
1. Run → View Breakpoints
2. 点击 + → Python Exception Breakpoints
3. 选择要捕获的异常类型
4. 当抛出该异常时自动暂停
"""

def risky_division(a, b):
    """除法运算（可能抛出异常）"""
    try:
        return a / b
    except ZeroDivisionError as e:
        # 设置异常断点后，程序会在这里暂停
        print(f"除零错误: {e}")
        return None

# 测试
risky_division(10, 2)
risky_division(10, 0)  # 异常断点会触发

# ============================================================================
# 第六部分：Evaluate Expression
# ============================================================================
"""
【Evaluate Expression 使用】

快捷键：Alt+F8

可以执行：
- 查看变量值
- 调用函数
- 修改变量
- 测试代码片段

示例：
在断点处按 Alt+F8，输入：
- numbers
- len(numbers)
- sum([x for x in numbers if x > 0])
- numbers.append(100)  # 修改变量
"""

def complex_calculation(data):
    """复杂计算"""
    # 在这里设置断点
    # 使用 Evaluate Expression 测试各种表达式
    
    filtered = [x for x in data if x > 0]
    total = sum(filtered)
    count = len(filtered)
    
    return total / count if count > 0 else 0

result = complex_calculation([1, -2, 3, -4, 5])
print(f"计算结果: {result}")

# ============================================================================
# 第七部分：调试技巧总结
# ============================================================================
"""
【调试最佳实践】

1. 从问题开始
   - 先理解问题是什么
   - 定位可能出错的代码区域

2. 合理设置断点
   - 在关键位置设置断点
   - 使用条件断点过滤

3. 观察变量变化
   - 使用 Variables 面板
   - 添加 Watches 监视关键表达式

4. 使用 Step 系列操作
   - Step Over: 不关心函数内部
   - Step Into: 需要查看函数内部
   - Step Out: 当前函数没问题，返回调用处

5. Evaluate Expression
   - 测试修复方案
   - 验证假设

【常用快捷键】

F8        - Step Over
F7        - Step Into
Shift+F8  - Step Out
F9        - Resume
Alt+F8    - Evaluate Expression
Ctrl+F8   - 切换断点
"""

# ============================================================================
# 本节小结
# ============================================================================
"""
✅ 掌握的知识点：
1. 各种断点类型
2. 调试控制操作
3. 变量监视
4. 条件断点
5. 异常断点
6. Evaluate Expression

➡️ 下一节：代码重构
"""

if __name__ == "__main__":
    print("\n" + "=" * 60)
    print("调试技巧模块学习完成！")
    print("=" * 60)